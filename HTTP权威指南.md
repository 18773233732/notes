# HTTP权威指南

## 第一章 HTTP概述

### 媒体类型

MiME类型（MIME type），最初设计MIME（Multipurpose Internet Mail Extension，多用途因特网邮件扩展）是为了解决在不同的电子邮件系统之间搬移报文时存在的问题。MIME在电子邮件系统中工作的非常好，因此HTTP也采纳了它，用它来描述并标记多媒体内容。

- HTML格式的文本文档由text/html类型来标记。
- 普通的ASCII文本由text/plain类型来标记。
- JPEG格式的图片为image/jpeg类型。
- GIF格式的图片为image/gif类型。
- Apple的QuickTime电影为movie/quicktime类型。
- 微软的Powerpoint演示文件为application/vnd.ms-powerpoint类型。

### URI

服务器资源名被称为**统一资源标识符**（Uniform Resource Identifier，URI）。

- URL

  > 统一资源定位符（URL）是资源标识符最常见的形式。URL描述了一台特定服务器上某资源的特定位置。

- URN

  > 统一资源名（URN）。URN是作为特定内容的唯一名称使用的，与目前的资源所在地无关，还可以用同一个名字通过多种网络协议来访问资源。

### 方法

HTTP支持几种不同的请求命令，这些命令被称为HTTP方法（HTTP method）。

- GET

  从服务器向客户端发送命名资源。

- PUT

  将来自客户端的数据储存到一个命名的服务器资源中去。

- DELETE

  从服务器中删除命名资源。

- POST

  将客户端数据发送到一个服务器网关应用程序。

- HEAD

  仅发送命名资源响应中的HTTP首部。

### 报文

从Web客户端发往Web服务器的HTTP报文称为请求报文（request message）。从服务发往客户端的报文称为响应报文（response message）。

HTTP报文包括：

- 起始行

  报文的第一行就是起始行，在请求报文中用来说明要做些什么，在响应报文中说明出现了什么情况。

- 首部字段

  起始行后面有零个或多个首部。每个首部字段都包含一个名字和一个值，为了便于解析，两者之间用冒号（:）来分隔。首部以一个空行结束。添加一个首部字段或添加新行一样简单。

- 主体

  空行之后就是可选的报文主体了，其中包含了所有类型的数据。请求主体中包含了要发送给Web服务器的数据；响应主体中装载了要返回客户端的数据。起始行和首部都是文本形式并且都是结构化的，而主体则不同，主体中可以包含任意的二进制数据（比如图片、视频、音轨、软件程序）。当然，主体中也可以包含文本。

### 连接

#### TCP/IP

HTTP是个应用层协议。HTTP无需操心网络通信的具体细节；它把联网的细节都交给了通用、可靠的因特网传输协议TCP/IP。  

TCP提供：

- 无差错的数据传输。
- 按序传输（数据总是会按照发送的顺序到达）。
- 未分段的数据流（可以在任意时刻以任意尺寸将数据发送出去）。

### Web的结构组件

#### 代理

位于客户端和服务器之间的HTTP中间实体。

#### 缓存

HTTP的仓库，使常用的页面的副本可以保存在离客户端更近的地方。

#### 网关

连接其他应用程序的特殊Web服务器。

#### 隧道

对HTTP通信报文进行盲转发的特殊代理。

#### Agent代理

发起自动HTTP请求的半智能Web客户端。

## 第二章 URL和资源

### URL的语法

```
<scheme>://<user>:<password>@<host>:<port>/<path>;<params>?<query>#<frag>
```

| 组件             | 描述                                                         | 默认值       |
| ---------------- | ------------------------------------------------------------ | ------------ |
| 方案（scheme）   | 访问服务器以获取资源时要使用哪种协议                         | 无           |
| 用户（user）     | 某些方案访问资源时需要的用户名                               | anonymous    |
| 密码（password） | 用户名后面可能要包含的密码，中间由冒号（:）分隔              | <E-mail地址> |
| 主机（host）     | 资源宿主服务器的主机名或点分IP地址                           | 无           |
| 端口（port）     | 资源宿主服务器正在监听的端口号。很多方案都有默认端口号（HTTP 的默认端口号为80） | 每个方案特有 |
| 路径             | 服务器上资源的本地名，由一个斜杠（/）将其与前面的URL组件分隔开来。路径组件的语法是与服务器和方案有关的 |              |
| 参数             | 某些方案会用这个组件来指定输入参数。参数为名/值对。 URL中可以包含多个参数字段，它们相互之间以及与路径的其余部分之间用分号（;）分隔 | 无           |
| 查询             | 某些方案会用这个组件传递参数以激活应用程序（比如数 据库、 公告板、搜索引擎以及其他因特网网关）。查询组件的内容没有通用格式。 用字符“?”将其与URL的其余部分分隔开来 | 无           |
| 片段             | 一小片或一部分资源的名字。引用对象时，不会将frag字段传送给服务器；这个字段是在客户端内部使用的。通过 字符“#”将其与URL 的其余部分分隔开来 | 无           |

### 常见的方案

| 方案   | 描述                                                         |
| ------ | ------------------------------------------------------------ |
| http   | 超文本传输协议方案，除了没有用户名和密码之外，与通用的URL格式相符。如果省略了端口， 就默认为80。<br />基本格式：http://<host>:<port>/<path>?<query>#<frag><br />示例：<br />http://www.joes-hardware.com/index.html<br />http://www.joes-hardware.com:80/index.html |
| https  | 方案https与方案http是一对。唯一的区别在于方案https使用了网景的SSL，SSL为HTTP连接提供了端到端的加密机制。其语法与HTTP的语法相同，默认端口为443。<br />基本格式： https://<host>:<port>/<path>?<query>#<frag><br />示例：https://www.joes-hardware.com/secure.html |
| mailto | Mailto URL指向的是E-mail地址。由于E-mail的行为与其他方案都有所不同（它并不指向任何可以直接访问的对象），所以mailto URL的格式与标准URL的格式也有所不同。因特网 E-mail地址的语法记录在RFC 822中。<br />基本格式：mailto:<RFC-822-addr-spec><br />示例：mailto:joe@joes-hardware.com |
| ftp    | 文件传输协议URL可以用来从FTP服务器上下载或向其上载文件，并获取FTP服务器上的目录结构内容的列表。在Web和URL出现之前FTP就已经存在了。Web应用程序将FTP作为一种数据访问方案使用。URL语法遵循下列通用格式。<br />基本格式：ftp://<user>:<password>@<host>:<port>/<path>;<params><br />示例：ftp://anonymous:joe%40joes-hardware.com@prep.ai.mit.edu:21/pub/gnu/ |

## 第三章 HTTP报文

### 报文流

HTTP报文是在HTTP应用程序之间发送的数据块。这些数据块以一些文本形式的元信息（meta-information）开头，这些信息描述了报的内容及含义，后面跟着可选的数据部分。这些报文在客户端、服务器和代理之间流动。术语“流入”、“流出”、“上游”及“下游”都是用来描述报文方向的。

### 报文的组成部分

HTTP报文是简单的格式化数据块。每条报文都包含一条来自客户端的请求，或者一条来自服务器的响应。它们由三个部分组成：对报文
进行描述的起始行（startline）、包含属性的首部（header）块，以及可选的、包含数据的主体（body）部分。

#### 起始行和首部

起始行和首部就是由行分隔的ASCII文本。每行都以一个由两个字符组成的行终止序列作为结束，其中包括一个回车符（ASCII码13）和一个换行符（ASCII码10）。这个行终止序列可以写做CRLF。需要指出的是，尽管HTTP规范中说明应该用CRLF来表示行终止，但稳健的应用程序也应该接受单个换行符作为行的终止。有些老的，或不完整的HTTP应用程序并不总是既发送回车符，又发送换行符。

#### 主体

实体的主体或报文的主体（或者就称为主体）是一个可选的数据块。与起始行和首部不同的是，主体中可以包含文本或二进制数据，也可以为空。

#### 报文的语法

- 请求报文（request message）

  格式：

  ```
  <method> <request-URL> <version>
  <headers>
  <entity-body>
  ```

  

- 响应报文（response message）

  格式：

  ```
  <version> <status> <reason-phrase>
  <headers>
  <entity-body>
  ```

  

#### 方法（method）

客户端希望服务器对资源执行的动作。

- HEAD

  > HEAD方法与GET方法的行为很类似，但服务器在响应中只返回首部。不会返回实体的主体部分。这就允许客户端在未获取实际资源的情况下，对资源的首部进行检查。使用HEAD，可以：
  > •在不获取资源的情况下了解资源的情况（比如，判断其类型）
  > •通过查看响应中的状态码，看看某个对象是否存在
  > •通过查看首部，测试资源是否被修改了

- GET

  > GET是最常用的方法。通常用于请求服务器发送某个资源。HTTP/1.1要求服务器
  > 实现此方法。

- PUT

  > 与GET从服务器读取文档相反，PUT方法会向服务器写入文档。有些发布系统允许用户创建Web页面，并用PUT直接将其安装到Web服务器上去。

- POST

  >POST方法起初是用来向服务器输入数据的。实际上，通常会用它来支持HTML的表单。表单中填好的数据通常会被送给服务器，然后由服务器将其发送到它要去的地方（比如，送到一个服务器网关程序中，然后由这个程序对其进行处理）。

- TRACE

  > 客户端发起一个请求时，这个请求可能要穿过防火墙、代理、网关或其他一些应用程序。每个中间节点都可能会修改原始的HTTP请求。TRACE方法允许客户端在最终将请求发送给服务器时，看看它变成了什么样子。

- OPTIONS

  > OPTIONS方法请求Web服务器告知其支持的各种功能。可以询问服务器通常支持哪些方法，或者对某些特殊资源支持哪些方法。（有些服务器可能只支持对一些特殊类型的对象使用特定的操作）。

- DELETE

  > DELETE方法所做的事情就是请服务器删除请求URL所指定的资源。但是，客户端应用程序无法保证删除操作一定会被执行。因为HTTP规范允许服务器在不通知客户端的情况下撤销请求。

安全方法：HTTP定义了一组被称为安全方法的方法。GET方法和HEAD方法都被认为是安全的，这就意味着使用GET或HEAD方法的HTTP请求都不会产生什么动作安全方法并不一定是什么动作都不执行的（实际上，这是由Web开发者决定的）。使用安全方法的目的就是当使用可能引发某一动作的不安全方法时，允许HTTP应用程序开发者通知用户。 

| 方法    | 描述                                                 | 是否包含主体 |
| ------- | ---------------------------------------------------- | :----------: |
| GET     | 从服务器获取一份文档                                 |      否      |
| HEAD    | 只从服务器获取文档的首部                             |      否      |
| POST    | 向服务器发送需要处理的数据                           |      是      |
| TRACE   | 对可能经过代理服务器传送到到服务器上去的报文进行追踪 |      否      |
| PUT     | 将请求的主体部分存储在服务器上                       |      是      |
| OPTIONS | 决定可以在服务器上执行哪些方法                       |      否      |
| DELETE  | 从服务器上删除一份文档                               |      否      |

#### 请求URL（request-URL）

命名了所请求资源，或者URL路径组件的完整URL。如果直接与服务器进行对话，只要URL的路径组件是资源的绝对路径，通常就不会有什么问题-服务器可以假定自己是URL的主机/端口。

#### 版本（version）

报文所使用的HTTP版本，其格式看起来是这样的：

`HTTP/<major>.<minor>`

其中主要版本号（major）和次要版本号（minor）都是整数。

#### 状态码

| 整体范围 | 已定义范围 | 分类       |
| -------- | ---------- | ---------- |
| 100～199 | 100～101   | 信息提示   |
| 200～299 | 200～206   | 成功       |
| 300～399 | 300～308   | 重定向     |
| 400～499 | 400～415   | 客户端错误 |
| 500～599 | 500～505   | 服务器错误 |

重定向

重定向状态码要么告知客户端使用替代位置来访问他们所感兴趣的资源，要么就提供一个替代的响应而不是资源的内容。如果资源已被移动，可发送一个重定向状态码和一个可选的Location首部来告知客户端资源已被移走，以及现在可以在哪里找到它。这样，浏览器就可以在不打扰使用者的情况下，透明地转入新的位置了。

**301** Moved Permanentl

> HTTP 301永久重定向说明请求的资源已经被移动到了由Location头部指定的url上，是固定的不会再改变。搜索引擎会根据该响应修正。
>
> 尽管标准要求浏览器在收到该响应并进行重定向时不应该修改httpmethod和body，但是有一些浏览器可能会有问题。所以最好是在应对GET或HEAD方法时使用301，其他情况使用308来替代301。

**302** Found

> HTTP 302 Found重定向状态码表明请求的资源被暂时的移动到了由该HTTP响应的响应头Location指定的URL上。浏览器会重定向到这个URL，但是搜索引擎不会对该资源的链接进行更新(In SEO-speak,it is said that the link-juice is not sent to the new URL)。
>
> 即使规范要求浏览器在重定向时保证请求方法和请求主体不变，但并不是所有的用户代理都会遵循这一点，你依然可以看到有缺陷的软件的存在。所以推荐仅在响应GET或HEAD方法时采用302状态码，而在其他时候使用307 Temporary Redirect来替代，因为在这些场景下方法变换是明确禁止的。
>
> 在确实需要将重定向请求的方法转换为GET的场景下，可以使用303 See Other。例如在使用PUT方法进行文件上传操作时，需要返回确认信息（例如“你已经成功上传了xyz”）而不是上传的资源本身，就可以使用这个状态码。

**303** See Other

> HTTP 303 See Other重定向状态码，通常作为PUT或POST操作的返回结果，它表示重定向链接指向的不是新上传的资源，而是另外一个页面，比如消息确认页面或上传进度页面。而请求重定向页面的方法要总是使用GET。

**307** Temporary Redirect

> HTTP 307 Temporary Redirect，临时重定向响应状态码，表示请求的资源暂时地被移动到了响应的Location首部所指向的URL上。原始请求中的请求方法和消息主体会在重定向请求中被重用。在确实需要将重定向请求的方法转换为GET的场景下，可以考虑使用303 See Other状态码。例如，在使用PUT方法进行文件上传操作时，如果需要返回一条确认信息（例如“你已经成功上传了XYZ”），而不是返回上传的资源本身，就可以使用这个状态码。
>
> 状态码307与302之间的唯一区别在于，当发送重定向请求的时候，307状态码可以确保请求方法和消息主体不会发生变化。如果使用302响应状态码，一些旧客户端会错误地将请求方法转换为GET：也就是说，在Web中，如果使用了GET以外的请求方法，且返回了302状态码，则重定向后的请求方法是不可预测的；但如果使用307状态码，之后的请求方法就是可预测的。对于GET请求来说，两种情况没有区别。

**308** Permanent Redirect

> 在HTTP协议中，308 Permanent Redirect（永久重定向）是表示重定向的响应状态码，说明请求的资源已经被永久的移动到了由Location首部指定的URL上。浏览器会进行重定向，同时搜索引擎也会更新其链接（用SEO的行话来说，意思是“链接汁”（link juice）被传递到了新的URL）。在重定向过程中，请求方法和消息主体不会发生改变，然而在返回301状态码的情况下，请求方法有时候会被客户端错误地修改为GET方法。

**400** Bad Request

> 用于告知客户端它发送了一个错误的请求

**403** Forbidden

> 用于说明请求被服务器拒绝了。如果服务器想说明为什么拒绝请求，可以包含实体的主体部分来对原因进行描述。但这个状态码通常是在服务器不想说明拒绝原因的时候使用的

**404** Not Found

> 用于说明服务器无法找到所请求的URL。通常会包含一个实体，以便客户端应用程序显示给用户看

**407** Request Timeout

> 如果客户端完成请求所花的时间太长，服务器可以回送此状态码，并关闭连接。超时时长随服务器的不同有所不同，但通常对所有的合法请求来说，都是够长的

